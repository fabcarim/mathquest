<!doctype html>
<html lang="it">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>MathQuest Lite Plus ¬∑ 1¬™‚Äì2¬™ media (v11.2)</title>
<style>
  :root{--bg:#f5f7ff;--fg:#111;--accent:#111;--muted:#6b7280;--accent2:#2563eb;--accent3:#0ea5e9;--accent4:#10b981;--accent5:#f59e0b;--accent6:#ec4899}
  body{margin:0;font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;background:linear-gradient(135deg,#eef2ff,#e0f2fe);color:var(--fg)}
  .wrap{max-width:1040px;margin:0 auto;padding:24px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  .btn{background:var(--accent);color:#fff;border:none;border-radius:16px;padding:10px 14px;cursor:pointer;box-shadow:0 2px 0 rgba(0,0,0,.2)}
  .btn.ghost{background:#fff;color:#111;border:1px solid #111}
  .btn[disabled]{opacity:.6;cursor:not-allowed}
  .card{background:rgba(255,255,255,.85);backdrop-filter:blur(6px);border-radius:16px;box-shadow:0 2px 10px rgba(0,0,0,.06);padding:16px}
  .pill{border:1px solid #111;border-radius:999px;padding:6px 10px;background:#fff;cursor:pointer}
  .pill.active{background:#111;color:#fff}
  .progress{height:8px;background:#e5e7eb;border-radius:8px;overflow:hidden}
  .bar{height:100%;background:var(--accent);width:0%}
  input.answer{width:100%;padding:10px 12px;border:1px solid #111;border-radius:12px}
  .hint{background:#e0f2fe;border-radius:12px;padding:10px;font-size:14px;white-space:pre-wrap}
  .ok{background:#dcfce7;border-radius:12px;padding:10px}
  .bad{background:#fef9c3;border-radius:12px;padding:10px}
  label.toggle{display:flex;align-items:center;gap:8px}
  .kicker{font-size:12px;color:var(--muted);text-transform:uppercase}
  .choice{background:#fff;color:#111;border:1px solid #111;border-radius:12px;padding:10px 12px;cursor:pointer;text-align:center}
  .choice.active{background:var(--accent);color:#fff}
  .overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;padding:16px;z-index:10}
  .modal{background:#fff;border-radius:16px;max-width:520px;width:100%;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,.25);text-align:center}
  .modal h3{margin:0 0 6px 0}
  .modal .sub{color:var(--muted);font-size:14px;margin-bottom:12px}
  .badge{display:inline-flex;align-items:center;gap:8px;border:1px solid #111;border-radius:999px;padding:6px 10px;background:#fff}
  .badges-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px}
  .badge-tile{border:1px solid #111;border-radius:14px;background:#fff;padding:12px;display:flex;flex-direction:column;gap:6px}
  .badge-tile.locked{opacity:.8}
  .badge-title{font-weight:700}
  .badge-cat{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
  <div class="wrap">
    <header class="row" style="justify-content:space-between;align-items:center">
      <h1>MathQuest Lite Plus ¬∑ 1¬™‚Äì2¬™ media (v11.2)</h1>
      <div class="row" style="align-items:center">
        <span style="font-size:14px;color:var(--muted)">Difficolt√†</span>
        <div id="levels" class="row"></div>
      </div>
    </header>

    <nav class="row" style="margin-top:12px">
      <button class="btn" id="btnPlay">Gioca ora</button>
      <button class="btn" id="btnTrain">Allenamento mirato</button>
      <button class="btn" id="btnProg">Progressi</button>
      <button class="btn ghost" id="btnSettings">Impostazioni</button>
      <button class="btn ghost" id="btnHome">Home</button>
    </nav>

    <section id="home" style="margin-top:16px">
      <div class="row">
        <div class="card" style="flex:1 1 360px">
          <h2>Benvenuta!</h2>
          <p style="color:var(--muted)">Obiettivo di oggi: <b id="goalVal">20</b> <b>risposte corrette</b>. Se ieri non lo raggiungi, oggi sale del <b>+10%</b>; se lo raggiungi, domani riparte da 20.</p>
          <div class="row"><button class="btn" id="startQuick">Inizia subito</button><button class="btn ghost" id="startTrain">Scegli argomento</button></div>
        </div>
        <div class="card" style="flex:1 1 360px">
          <h2>Stato di oggi</h2>
          <div class="kicker">Conta solo il giorno corrente</div>
          <p>Corrette oggi: <b id="correctToday">0</b> / <b id="goalVal2">20</b></p>
          <div class="progress"><div class="bar" id="goalBar"></div></div>
          <p class="kicker" id="goalNote">‚Äî</p>
        </div>
      </div>
      <div class="card" style="margin-top:12px">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div>
            <div class="kicker">Cambia argomento rapido</div>
            <div id="quickTopics" class="row" style="margin-top:6px"></div>
          </div>
          <div><button class="btn ghost" id="clearTopic">Nessun filtro</button></div>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <h2>üèÖ Badge</h2>
        <div class="kicker">Guadagnati</div>
        <div id="homeBadgesEarned" class="badges-grid" style="margin-top:6px"></div>
        <div class="kicker" style="margin-top:12px">Da conquistare</div>
        <div id="homeBadgesLocked" class="badges-grid" style="margin-top:6px"></div>
      </div>
    </section>

    <section id="train" style="display:none;margin-top:16px">
      <div class="card">
        <h2>Seleziona argomento</h2>
        <div id="topics" class="row" style="margin-top:8px"></div>
        <div class="row" style="margin-top:8px"><button class="btn" id="trainGo">Inizia allenamento</button><button class="btn ghost" id="resetTopic">Reset argomento</button></div>
      </div>
    </section>

    <section id="play" style="display:none;margin-top:16px">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div>
            <div id="topicLabel" class="kicker">‚Äî</div>
            <div style="font-size:14px;color:var(--muted)">Difficolt√† <span id="diffLabel">2</span> <span class="kicker" id="autoDiffTag" style="margin-left:6px"></span></div>
          </div>
          <div style="font-size:14px">Serie corretta: <b id="streak">0</b></div>
        </div>
        <div id="stem" style="margin-top:8px;font-size:20px;font-weight:600">‚Äî</div>
        <div class="kicker" id="stemMeta"></div>
        <div id="answerUI" style="margin-top:10px"></div>
        <div class="row" style="margin-top:10px;align-items:center">
          <button class="btn" id="btnConfirm">Conferma</button>
          <button class="btn ghost" id="btnNext" disabled>Prossima</button>
          <button class="btn ghost" id="btnHint">Mostra hint</button>
          <button class="btn ghost" id="btnSimilar">Esempio simile</button>
        </div>
        <div id="feedback" style="margin-top:10px"></div>
        <div id="hints" style="margin-top:10px;display:none" class="hint"></div>
      </div>
      <div class="row" style="margin-top:12px">
        <div class="card" style="flex:1 1 320px">
          <div> Oggi corrette: <b id="corToday2">0</b> / <b id="goalSmall">20</b></div>
          <div class="progress" style="margin-top:6px"><div class="bar" id="goalBar2"></div></div>
          <div class="kicker" id="goalHint"></div>
        </div>
        <div class="card" style="flex:1 1 320px">
          <div>Badge</div>
          <div id="badges" class="row" style="margin-top:6px"></div>
        </div>
      </div>
    </section>

    <section id="progress" style="display:none;margin-top:16px">
      <div class="card">
        <h2>Riepilogo</h2>
        <div>Accuratezza complessiva: <b id="accTot">0%</b> ¬∑ Esercizi totali: <b id="totAns">0</b></div>
        <div class="kicker" id="daysDone">Giorni obiettivo completato: 0</div>
        <div id="badgesList" style="margin-top:10px"></div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="btnExport">Esporta CSV</button>
        </div>
        <div style="margin-top:10px" id="byTopic"></div>
        <div style="margin-top:10px" id="suggestions" class="kicker"></div>
      </div>
    </section>

    <section id="settings" style="display:none;margin-top:16px">
      <div class="card">
        <h2>Impostazioni</h2>
        <div class="row" style="align-items:center;margin-top:8px">
          <label class="toggle"><input type="checkbox" id="toggleAuto" checked> Avanzamento automatico dopo risposta corretta</label>
        </div>
        <div class="row" style="align-items:center;margin-top:8px">
          <label class="toggle"><input type="checkbox" id="toggleAutoMC" checked> Conferma automatica nelle domande a scelta</label>
        </div>
        <div class="row" style="align-items:center;margin-top:8px">
          <label class="toggle"><input type="checkbox" id="toggleAutoDiff" checked> Difficolt√† automatica</label>
        </div>
        <div class="row" style="align-items:center;margin-top:8px">
          <small class="kicker">Obiettivo adattivo: base 20, +10% se ieri non completato, reset a 20 se ieri completato.</small>
        </div>
        <div class="row" style="margin-top:8px">
          <button class="btn" id="btnReset">Reset dati</button>
        </div>
      </div>
    </section>

    <footer style="margin-top:24px;font-size:12px;color:var(--muted)">
      Consigli: 10‚Äì15 min al giorno. Privacy: dati solo in locale.
    </footer>
  </div>

  <div class="overlay" id="overlay">
    <div class="modal">
      <h3>üéâ Obiettivo raggiunto!</h3>
      <div class="sub">Hai raggiunto <b id="goalCount"></b>/<b id="goalCountTot"></b> risposte corrette oggi. Accuracy: <b id="goalAcc"></b>%</div>
      <div class="sub">Hai sbloccato un <b>badge</b> üèÖ Obiettivo Giornaliero!</div>
      <button class="btn" id="btnHomeNow">Torna ora alla Home</button>
      <div class="kicker" style="margin-top:8px">Torno automaticamente alla Home tra <span id="countdown">5</span>s‚Ä¶</div>
    </div>
  </div>

<script>
// ===== Utilities
function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function randChoice(arr){ return arr[Math.floor(Math.random()*arr.length)]; }
function gcd(a,b){ return b ? gcd(b, a%b) : Math.abs(a); }
function lcm(a,b){ return Math.abs(a*b)/gcd(a,b); }
function dec(x,p){ if(p===undefined) p=2; return Number.parseFloat(x.toFixed(p)); }
function approxEqual(a,b,eps){ if(eps===undefined) eps=1e-6; return Math.abs(Number(a)-Number(b))<=eps; }
function shuffle(arr){ return arr.map(function(v){return [Math.random(),v];}).sort(function(a,b){return a[0]-b[0];}).map(function(x){return x[1];}); }
function fmtUnit(val,unit){ return String(val)+' '+unit; }
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

// Accent colors per topic
var topicAccent = {
  "Calcolo interi":"var(--accent2)",
  "Decimali":"var(--accent3)",
  "Frazioni":"var(--accent4)",
  "Percentuali":"var(--accent5)",
  "Proporzioni":"var(--accent6)",
  "Equazioni":"#7c3aed",
  "Geometria":"#059669",
  "Misure":"#0ea5e9",
  "Potenze":"#ef4444",
  "Radici":"#8b5cf6",
  "Numero teoria":"#22c55e",
  "Problemi":"#f97316",
  "Statistiche":"#14b8a6"
};
function applyAccentForTopic(t){
  var color = topicAccent[t] || "#111";
  document.documentElement.style.setProperty('--accent', color);
}

// ===== State
var state = {
  screen: 'home',
  difficulty: 2,
  topicFilter: null,
  question: null,
  input: '',
  history: [],
  streak: 0,
  answered: 0,
  correct: 0,
  answeredThis: false,
  sessionStart: Date.now(),
  autoAdvance: true,
  autoConfirmMC: true,
  autoDiff: true,
  dailyGoal: 20,
  lastDailyGoal: 20,
  lastDayKey: null,
  completions: [],
  goalShownToday: false,
  badges: []
};

var topicsList = ["Calcolo interi","Decimali","Frazioni","Percentuali","Proporzioni","Equazioni","Geometria","Misure","Potenze","Radici","Numero teoria","Problemi","Statistiche"];

// ===== Time helpers
function dayKey(ts){
  if(ts===undefined) ts=Date.now();
  var d=new Date(ts);
  var mm=('0'+(d.getMonth()+1)).slice(-2);
  var dd=('0'+d.getDate()).slice(-2);
  return d.getFullYear()+"-"+mm+"-"+dd;
}
function historyForDay(hist, key){ return hist.filter(function(h){ return dayKey(h.ts)===key; }); }
function todayHistory(hist){ return historyForDay(hist, dayKey()); }

// ===== Badge helpers
function byTopicAll(hist){ var m={}; hist.forEach(function(h){ if(!m[h.topic]) m[h.topic]={correct:0,total:0}; m[h.topic].total++; if(h.ok) m[h.topic].correct++; }); return m; }
function streakInfo(days){ var set={}; days.forEach(function(d){ set[d]=true; }); var arr=Object.keys(set).sort(); var best=0, cur=0, prev=null; arr.forEach(function(d){ if(prev){ var n=new Date(prev); n.setDate(n.getDate()+1); var y=n.getFullYear(), m=('0'+(n.getMonth()+1)).slice(-2), da=('0'+n.getDate()).slice(-2); var nextKey=y+'-'+m+'-'+da; if(d===nextKey){ cur+=1; } else { cur=1; } } else { cur=1; } if(cur>best) best=cur; prev=d; }); return {best:best}; }
function fastTenToday(hist){ var today = todayHistory(hist).filter(function(h){return h.ok;}); if(today.length<10) return false; for(var i=0;i<=today.length-10;i++){ var t0=today[i].ts, t9=today[i+9].ts; if(t9 - t0 <= 5*60*1000) return true; } return false; }
function fastTenProgressText(hist){ var today = todayHistory(hist).filter(function(h){return h.ok;}); if(today.length===0) return "0/10"; var best=1; for(var i=0;i<today.length;i++){ for(var j=i;j<today.length;j++){ if(today[j].ts - today[i].ts <= 5*60*1000){ best = Math.max(best, j-i+1); } } } return String(Math.min(10,best))+"/10"; }

var badgeCatalog = [
  { id:'daily_hero', label:'Daily Hero', cat:'Progressi', desc:'Completa l‚Äôobiettivo giornaliero una volta.', check:function(S){ return S.completions.length>=1; }, progress:function(S){ return String(Math.min(1,S.completions.length))+'/1'; } },
  { id:'streak_3', label:'Streak 3 giorni', cat:'Progressi', desc:'Completa l‚Äôobiettivo per 3 giorni di fila.', check:function(S){ return streakInfo(S.completions).best>=3; }, progress:function(S){ return String(Math.min(3,streakInfo(S.completions).best))+'/3'; } },
  { id:'streak_5', label:'Streak 5 giorni', cat:'Progressi', desc:'Completa l‚Äôobiettivo per 5 giorni di fila.', check:function(S){ return streakInfo(S.completions).best>=5; }, progress:function(S){ return String(Math.min(5,streakInfo(S.completions).best))+'/5'; } },
  { id:'topic_master', label:'Topic Master', cat:'Competenza', desc:'Ottieni 50 risposte corrette in un singolo argomento.', 
    check:function(S){ var by=byTopicAll(S.history); return Object.keys(by).some(function(k){return by[k].correct>=50;}); },
    progress:function(S){ var by=byTopicAll(S.history); var best=0; Object.keys(by).forEach(function(k){ if(by[k].correct>best) best=by[k].correct; }); return String(Math.min(50,best))+'/50'; } },
  { id:'ace_90', label:'Ace 90%', cat:'Precisione', desc:'‚â•90% in un argomento (‚â•10 domande).',
    check:function(S){ var by=byTopicAll(S.history); return Object.keys(by).some(function(k){ return by[k].total>=10 && (100*by[k].correct/by[k].total)>=90; }); },
    progress:function(S){ var by=byTopicAll(S.history); var best=0; Object.keys(by).forEach(function(k){ if(by[k].total>=10){ var pc=Math.round(100*by[k].correct/by[k].total); if(pc>best) best=pc; } }); return String(best)+'% / 90%'; } },
  { id:'fast10', label:'Fast Ten', cat:'Velocit√†', desc:'10 corrette in ‚â§5 minuti (oggi).',
    check:function(S){ return fastTenToday(S.history); },
    progress:function(S){ return fastTenProgressText(S.history); } },
  { id:'variety_8', label:'Explorer', cat:'Variet√†', desc:'Allena almeno 8 argomenti in un solo giorno.',
    check:function(S){ var set={}; todayHistory(S.history).forEach(function(h){ set[h.topic]=true; }); return Object.keys(set).length>=8; },
    progress:function(S){ var set={}; todayHistory(S.history).forEach(function(h){ set[h.topic]=true; }); var n=Object.keys(set).length; return String(Math.min(8,n))+'/8'; } }
];

function addBadge(id,label){ if(state.badges.some(function(b){return b.id===id;})) return; state.badges.push({id:id,label:label,ts:Date.now()}); saveState(); renderBadges(); renderBadgesList(); renderHomeBadges(); }

// === Badge renderers
function progressPercent(text){
  var xy = String(text).match(/(\d+)\s*\/\s*(\d+)/);
  if(xy){ var num=Number(xy[1]), den=Number(xy[2]); return Math.max(0,Math.min(100, Math.round(100*num/den))); }
  var pc = String(text).match(/(\d+)\s*%/);
  if(pc){ var val=Number(pc[1]); var m = String(text).match(/\/\s*(\d+)\s*%/); var needed = m? Number(m[1]) : 100; return Math.max(0,Math.min(100, Math.round(100*val/needed))); }
  return 0;
}
function renderBadges(){
  var c=document.getElementById('badges'); if(!c) return;
  c.innerHTML='';
  if(!state.badges.length){
    c.innerHTML="<span class=\"kicker\">Nessun badge ancora ‚Äî completa l'obiettivo giornaliero!</span>";
    return;
  }
  state.badges.slice().reverse().forEach(function(b){
    var el=document.createElement('div');
    el.className='badge';
    el.innerHTML='üèÖ <b>'+b.label+'</b>';
    c.appendChild(el);
  });
}
function renderBadgesList(){
  var c=document.getElementById('badgesList'); if(!c) return;
  c.innerHTML='';
  if(!state.badges.length){
    c.innerHTML='<div class="kicker">Nessun badge ancora</div>';
    return;
  }
  state.badges.slice().reverse().forEach(function(b){
    var date=new Date(b.ts).toLocaleDateString();
    var row=document.createElement('div');
    row.className='card';
    row.innerHTML='<div><b>üèÖ '+b.label+'</b></div><div class="kicker">'+date+'</div>';
    c.appendChild(row);
  });
}
function renderHomeBadges(){
  var earnedC = document.getElementById('homeBadgesEarned');
  var lockedC = document.getElementById('homeBadgesLocked');
  if(!earnedC || !lockedC) return;
  earnedC.innerHTML=''; lockedC.innerHTML='';
  var prog = {};
  badgeCatalog.forEach(function(b){
    var text;
    try { text = b.progress(state); } catch(e){ text = '0/1'; }
    prog[b.id] = text;
  });
  var earnedIds = {}; state.badges.forEach(function(b){ earnedIds[b.id]=true; });
  badgeCatalog.forEach(function(b){
    var isEarned = !!earnedIds[b.id];
    var tile = document.createElement('div');
    tile.className = 'badge-tile' + (isEarned? '' : ' locked');
    var pct = progressPercent(prog[b.id]||'0/1');
    tile.innerHTML = '<div class="badge-title">'+(isEarned?'üèÖ':'üîí')+' '+b.label+'</div>' +
      '<div class="badge-cat">'+b.cat+'</div>' +
      '<div style="font-size:13px">'+b.desc+'</div>' +
      '<div class="progress"><div class="bar" style="width:'+pct+'%"></div></div>' +
      '<div class="kicker">'+(prog[b.id]||'')+'</div>';
    (isEarned? earnedC : lockedC).appendChild(tile);
  });
}

function ensureCatalogBadges(){
  badgeCatalog.forEach(function(b){
    try{
      if(b.check(state) && !state.badges.some(function(x){return x.id===b.id;})){
        addBadge(b.id, b.label);
      }
    }catch(e){}
  });
}

// ===== Persistence
function saveState(){ try{ var payload={history: state.history, answered: state.answered, correct: state.correct, streak: state.streak, difficulty: state.difficulty, autoAdvance: state.autoAdvance, autoConfirmMC: state.autoConfirmMC, autoDiff: state.autoDiff, dailyGoal: state.dailyGoal, lastDailyGoal: state.lastDailyGoal, lastDayKey: state.lastDayKey, completions: state.completions, goalShownToday: state.goalShownToday, badges: state.badges, topicFilter: state.topicFilter}; localStorage.setItem('mqLiteState', JSON.stringify(payload)); }catch(e){} }
function loadState(){ try{ var raw=localStorage.getItem('mqLiteState'); if(!raw) return; var s=JSON.parse(raw); if(s){ state.history=s.history||[]; state.answered=s.answered||0; state.correct=s.correct||0; state.streak=s.streak||0; state.difficulty=s.difficulty||state.difficulty; state.autoAdvance = (typeof s.autoAdvance==='boolean')? s.autoAdvance : true; state.autoConfirmMC = (typeof s.autoConfirmMC==='boolean')? s.autoConfirmMC : true; state.autoDiff = (typeof s.autoDiff==='boolean')? s.autoDiff : true; state.dailyGoal = s.dailyGoal||20; state.lastDailyGoal = s.lastDailyGoal||state.dailyGoal||20; state.lastDayKey = s.lastDayKey||null; state.completions = s.completions||[]; state.goalShownToday = !!s.goalShownToday; state.badges = s.badges||[]; state.topicFilter = s.topicFilter||null; } }catch(e){} }

// ===== Adaptive daily goal roll-over
function rollDailyGoalOnNewDay(){
  var today = dayKey();
  var prevKey = state.lastDayKey;
  if(prevKey && prevKey !== today){
    var prevCorrect = historyForDay(state.history, prevKey).filter(function(h){return h.ok;}).length;
    var prevGoal = state.lastDailyGoal || 20;
    var completed = prevCorrect >= prevGoal;
    var newGoal = completed ? 20 : Math.ceil(prevGoal * 1.10);
    newGoal = clamp(newGoal, 10, 100);
    state.dailyGoal = newGoal;
    state.lastDailyGoal = newGoal;
    state.goalShownToday = false;
    if(completed && state.completions.indexOf(prevKey)===-1) state.completions.push(prevKey);
  }
  if(!state.lastDayKey) { state.lastDayKey = today; state.lastDailyGoal = state.dailyGoal||20; }
  if(state.lastDayKey !== today){ state.lastDayKey = today; }
  saveState();
}

// ===== Auto difficulty
function recentWindow(n){
  if(n===undefined) n=20;
  var arr = state.history.slice(-n);
  var attempts = arr.length;
  var ok = arr.filter(function(h){return h.ok;}).length;
  var acc = attempts? Math.round(100*ok/attempts) : null;
  var last5 = state.history.slice(-5);
  var wrongLast5 = last5.filter(function(h){return !h.ok;}).length;
  return {attempts:attempts, ok:ok, acc:acc, wrongLast5:wrongLast5};
}
function autoAdjustDifficulty(){
  if(!state.autoDiff){ var t=document.getElementById('autoDiffTag'); if(t) t.textContent=''; return; }
  var w = recentWindow(20);
  var d = state.difficulty;
  if(w.attempts >= 8){
    if((w.acc!==null && w.acc >= 85) && state.streak >= 3){ d = Math.min(3, d+1); }
    if((w.acc!==null && w.acc < 60) || w.wrongLast5 >= 3){ d = Math.max(1, d-1); }
  }
  if(d !== state.difficulty){ state.difficulty = d; saveState(); }
  var tag = document.getElementById('autoDiffTag');
  if(tag) tag.textContent = '(auto)';
  Array.prototype.forEach.call(document.querySelectorAll('#levels .pill'), function(x,i){ x.classList.toggle('active', (i+1)===state.difficulty); });
  var dl = document.getElementById('diffLabel');
  if(dl) dl.textContent = state.difficulty;
}

// ===== Choice sanitizer (no echo answers, distinct options)
function sanitizeChoices(stem, choices, correct){
  var uniq = [];
  choices.forEach(function(c){ if(uniq.indexOf(String(c))===-1) uniq.push(String(c)); });
  choices = uniq;
  var fracMatch = stem.match(/(\d+)\s*\/\s*(\d+)/);
  var fracInStem = fracMatch ? (fracMatch[1]+'/'+fracMatch[2]) : null;
  if(/equivalent/i.test(stem) || /equival/i.test(stem)){
    if(fracInStem){ choices = choices.filter(function(c){ return c !== fracInStem; }); }
  }
  if(typeof correct === 'string' && correct.indexOf('%')>=0 && fracInStem){
    choices = choices.filter(function(c){ return c !== fracInStem; });
  }
  if(choices.indexOf(String(correct))===-1){ choices.unshift(String(correct)); }
  while(choices.length < 4){
    var d;
    if(typeof correct === 'string' && correct.indexOf('%')>=0){
      var num = parseFloat(correct.replace(',', '.').replace('%',''));
      var tweak = Math.max(1, Math.round((Math.random()*8+2)));
      d = (Math.abs(num + (Math.random()<0.5?-tweak:tweak)).toFixed(2)).replace('.',',') + '%';
    } else if(/^\d+\/\d+$/.test(String(correct))){
      var parts = String(correct).split('/');
      var n = parseInt(parts[0],10);
      var dn = parseInt(parts[1],10);
      var tweak2 = (Math.random()<0.5? n+1 : Math.max(1,n-1));
      d = String(tweak2)+'/'+String(dn);
    } else {
      var num2 = Number(correct);
      d = String(num2 + (Math.random()<0.5? 1 : -1));
    }
    if(choices.indexOf(String(d))===-1) choices.push(String(d));
  }
  return shuffle(choices.slice(0,4));
}

function makeQ(topic, type, stem, meta, answer, choices, hints, solution){
  return { topic: topic, type: type, stem: stem, meta: meta, answer: answer, choices: choices, hints: hints, solution: solution };
}

// ===== Builders
var Builders = {
  "Calcolo interi": function(D){
    var op = randChoice(['+','-','√ó','√∑']); var a,b,stem,meta='',ans;
    if(op==='+'){a=randInt(100*D,300*D);b=randInt(50*D,150*D);ans=a+b;stem='Calcola la somma'; meta='Rispondi con un numero intero. Operazione: '+a+' + '+b;}
    if(op==='-'){a=randInt(150*D,400*D);b=randInt(50*D,149*D); if(b>a){var t=a;a=b;b=t;} ans=a-b; stem='Calcola la differenza'; meta='Rispondi con un numero intero. Operazione: '+a+' ‚àí '+b;}
    if(op==='√ó'){a=randInt(6,12*D);b=randInt(6,12*D);ans=a*b;stem='Calcola il prodotto'; meta='Rispondi con un numero intero. Operazione: '+a+' √ó '+b;}
    if(op==='√∑'){b=randInt(2,12*D);ans=randInt(6,12*D);a=ans*b;stem='Calcola il quoziente'; meta='Risposta intera. Operazione: '+a+' √∑ '+b;}
    return makeQ('Calcolo interi','input',stem,meta,ans,null,["Esegui l'operazione nell'ordine dato"],String(ans));
  },
  "Decimali": function(D){
    var mode = randChoice(['somma','prodotto','arrotonda']); var a=dec(randInt(10,80)/10,1), b=dec(randInt(10,80)/10,1);
    if(mode==='somma') return makeQ('Decimali','input','Somma con decimali','Arrotonda il risultato a 2 cifre decimali. Operazione: '+a+' + '+b,dec(a+b,2),null,['Allinea la virgola','Arrotonda a 2 decimali'],dec(a+b,2).toFixed(2));
    if(mode==='prodotto'){ var ans=dec(a*b,2); return makeQ('Decimali','input','Prodotto con decimali','Arrotonda il risultato a 2 cifre decimali. Operazione: '+a+' √ó '+b,ans,null,['Conta le cifre decimali','Arrotonda a 2 decimali'],ans.toFixed(2)); }
    var target = randChoice([0,1,2]); return makeQ('Decimali','input','Arrotondamento','Arrotonda '+a+' esattamente a '+target+' cifre decimali.',dec(a,target),null,['Regola del 5'],dec(a,target).toFixed(target));
  },
  "Frazioni": function(D){
    var a = randInt(1,9), b = randInt(2,9); var g0 = gcd(a,b); a = Math.floor(a/g0); b = Math.floor(b/g0); if(a===b){ b = b+1; }
    var k = randInt(2,5); var aK = a*k, bK = b*k; var variant = randChoice(['askBase','askScaled']);
    if(variant==='askBase'){ var correct = aK+'/'+bK; var opts = [correct, a+'/'+bK, aK+'/'+b, (aK+1)+'/'+bK]; var stem='Frazioni equivalenti'; var meta='Scegli una frazione equivalente a '+a+'/'+b+' (diversa da '+a+'/'+b+').'; return makeQ('Frazioni','mc',stem,meta,correct,sanitizeChoices(stem+' '+meta, opts, correct),['Moltiplica numeratore e denominatore per lo stesso numero'], correct); }
    else { var correct2 = a+'/'+b; var opts2 = [correct2, aK+'/'+b, a+'/'+bK, aK+'/'+(bK+1)]; var stem2='Frazioni equivalenti'; var meta2='Scegli una frazione equivalente a '+aK+'/'+bK+' (diversa da '+aK+'/'+bK+').'; return makeQ('Frazioni','mc',stem2,meta2,correct2,sanitizeChoices(stem2+' '+meta2, opts2, correct2),['Riduci ai minimi termini','Dividi per lo stesso numero'], correct2); }
  },
  "Percentuali": function(D){
    var mode=randChoice(['percOf','fracToPerc','percToFrac']);
    if(mode==='percOf'){ var p=randChoice([10,12.5,20,25,30,40,50]); var x=randInt(16*D,80*D); var a=dec(x*p/100,2); return makeQ('Percentuali','input','Percentuale di una quantit√†','Calcola il '+p+'% di '+x+'. Arrotonda a 2 decimali se serve.',a,null,['Trasforma in decimale: p/100'],String(a)); }
    if(mode==='fracToPerc'){ var d=randChoice([2,4,5,8,10]); var n=randInt(1,d-1); var a2=dec(100*n/d,2)+'%'; var ch=[a2, dec(n/d,2).toString(), String(n*d)+'%', String(d)+'/'+String(n)+'%']; var stem='Da frazione a percentuale'; var meta='Converti '+n+'/'+d+' in percentuale (es. 12,5%)'; return makeQ('Percentuali','mc',stem,meta,a2,sanitizeChoices(stem+' '+meta, ch, a2),['(n/d)*100'], a2); }
    var mp={"12.5":[1,8],"20":[1,5],"25":[1,4],"37.5":[3,8],"50":[1,2],"62.5":[5,8],"75":[3,4]}; var keys=Object.keys(mp); var pk=randChoice(keys); var nn=mp[pk][0], dd=mp[pk][1]; var stem2='Percentuale come frazione'; var meta2='Scrivi '+pk+'% come frazione in termini minimi.'; var corr=nn+'/'+dd; return makeQ('Percentuali','mc',stem2,meta2,corr,sanitizeChoices(stem2+' '+meta2,[corr,'1/3','2/5','5/12'],corr),['Riduci per MCD'], corr);
  },
  "Proporzioni": function(D){
    var a=randInt(2*D,12*D), b=randInt(2*D,12*D), c=randInt(2*D,12*D); var x=Math.round((b*c)/a); return makeQ('Proporzioni','input','Completa la proporzione',a+' : '+b+' = '+c+' : x ‚Äî Trova x (intero).',x,null,['Prodotto medi = prodotto estremi'],String(x));
  },
  "Equazioni": function(D){
    var a=randInt(2,7), x=randInt(2*D,15*D), b=randInt(-10,10); var c=a*x+b; return makeQ('Equazioni','input',"Risolvi l'equazione di 1¬∫ grado", a+'x '+(b>=0?'+':'-')+' '+Math.abs(b)+' = '+c+'. Trova x (intero).', x, null, ['Isola x: (c - b)/a'], 'x='+x);
  },
  "Geometria": function(D){
    var shape=randChoice(['rettangolo','triangolo','quadrato','cerchio']);
    if(shape==='rettangolo'){ var B=randInt(5*D,20*D), H=randInt(5*D,20*D); return makeQ('Geometria','input','Area del rettangolo','Base '+fmtUnit(B,'cm')+', altezza '+fmtUnit(H,'cm')+'. Rispondi in cm¬≤ (intero). Formula: A=b¬∑h.',B*H,null,['Moltiplica base √ó altezza'],String(B*H)); }
    if(shape==='triangolo'){ var B2=randInt(6*D,20*D), H2=randInt(4*D,18*D); return makeQ('Geometria','input','Area del triangolo','Base '+fmtUnit(B2,'cm')+', altezza '+fmtUnit(H2,'cm')+'. Rispondi in cm¬≤ (usa A=(b¬∑h)/2).',(B2*H2)/2,null,['Dividi per 2'],String((B2*H2)/2)); }
    if(shape==='quadrato'){ var L=randInt(4*D,20*D); return makeQ('Geometria','input','Perimetro del quadrato','Lato '+fmtUnit(L,'cm')+'. Rispondi in cm (intero).',4*L,null,['P=4¬∑l'],String(4*L)); }
    var r=randInt(3,10); var pi=3.14; return makeQ('Geometria','input','Circonferenza del cerchio','Raggio '+fmtUnit(r,'cm')+'. Usa œÄ‚âà3,14 e arrotonda a 2 decimali.',dec(2*pi*r,2),null,['C=2œÄr'],dec(2*pi*r,2).toFixed(2));
  },
  "Misure": function(D){
    var type=randChoice(['L','kg','km','cm2']);
    if(type==='L'){ var L=dec(randInt(5,30)/2,1); return makeQ('Misure','input','Conversione di capacit√†','Converti '+L+' L in mL.',L*1000,null,['√ó1000'],String(L*1000)); }
    if(type==='kg'){ var kg=dec(randInt(10,50)/10,1); return makeQ('Misure','input','Conversione di massa','Converti '+kg+' kg in g.',kg*1000,null,['√ó1000'],String(kg*1000)); }
    if(type==='km'){ var km=dec(randInt(10,80)/10,1); return makeQ('Misure','input','Conversione di lunghezza','Converti '+km+' km in m.',km*1000,null,['√ó1000'],String(km*1000)); }
    var c=randInt(5*D,40*D); return makeQ('Misure','input','Conversione di area','Converti '+c+' cm¬≤ in mm¬≤.',c*100,null,['√ó100 (per le aree cm¬≤‚Üímm¬≤)'],String(c*100));
  },
  "Potenze": function(D){
    var mode = randChoice(['calc','product','quotient','powerOfPower','tenPow','compare','expand','compress']);
    if(mode==='calc'){
      var a=randChoice([2,3,4,5,6,7,8,9]); var e=randChoice([2,3,4]);
      return makeQ('Potenze','input','Calcola la potenza','Calcola '+a+'^'+e+'. Rispondi con un intero.', Math.pow(a,e), null, ['Moltiplica la base per se stessa e volte l‚Äôesponente'], String(Math.pow(a,e)));
    }
    if(mode==='product'){
      var ab=randChoice([2,3,5,7]); var m=randInt(1,4), n=randInt(1,4);
      var ansExp=m+n;
      return makeQ('Potenze','input','Prodotto di potenze con la stessa base','Semplifica: '+ab+'^'+m+' ¬∑ '+ab+'^'+n+' = '+ab+'^?', ansExp, null, ['Somma gli esponenti: a^m ¬∑ a^n = a^(m+n)'], String(ansExp));
    }
    if(mode==='quotient'){
      var aq=randChoice([2,3,5,7]); var m2=randInt(2,5), n2=randInt(1,m2-1);
      var ansExp2=m2-n2;
      return makeQ('Potenze','input','Quoziente di potenze con la stessa base','Semplifica: '+aq+'^'+m2+' : '+aq+'^'+n2+' = '+aq+'^?', ansExp2, null, ['Sottrai gli esponenti: a^m : a^n = a^(m‚àín)'], String(ansExp2));
    }
    if(mode==='powerOfPower'){
      var ap=randChoice([2,3,4,5]); var m3=randInt(2,4), n3=randInt(2,3);
      var ansExp3=m3*n3;
      return makeQ('Potenze','input','Potenza di potenza','Semplifica: ('+ap+'^'+m3+')^'+n3+' = '+ap+'^?', ansExp3, null, ['Moltiplica gli esponenti: (a^m)^n = a^(m¬∑n)'], String(ansExp3));
    }
    if(mode==='tenPow'){
      var n4=randInt(1,5);
      var ans4 = Math.pow(10,n4);
      return makeQ('Potenze','input','Potenze di 10','Calcola 10^'+n4+'.', ans4, null, ['Sposta la virgola di n posizioni a destra'], String(ans4));
    }
    if(mode==='compare'){
      var a5=randChoice([2,3,4,5]); var b5=randChoice([2,3,4,5]);
      var m5=randInt(2,5); var n5=randInt(2,5);
      var A = Math.pow(a5,m5), B = Math.pow(b5,n5);
      var correct = (A===B) ? (a5+'^'+m5) : (A>B? (a5+'^'+m5) : (b5+'^'+n5));
      var stem='Confronto tra potenze'; var meta='Quale √® maggiore?'; var ch=[a5+'^'+m5, b5+'^'+n5, a5+'^'+n5, b5+'^'+m5];
      return makeQ('Potenze','mc',stem,meta,correct, sanitizeChoices(stem+' '+meta, ch, correct), ['Calcola o ragiona sulla crescita della base/esponente'], correct);
    }
    if(mode==='expand'){
      var a6=randChoice([2,3,4,5]); var e6=randInt(2,5);
      var correctStr = new Array(e6+1).join(String(a6)+' √ó ').slice(0,-3);
      var stem2='Espansione di una potenza'; var meta2='Espandi '+a6+'^'+e6+' come moltiplicazione ripetuta.';
      return makeQ('Potenze','mc',stem2,meta2,correctStr, sanitizeChoices(stem2+' '+meta2, [correctStr, a6+'^'+e6, a6+' √ó '+a6+'^'+(e6-1), (a6+1)+' √ó '+a6+'^'+(e6-1)], correctStr), ['Ripeti la base e volte'], correctStr);
    }
    if(mode==='compress'){
      var a7=randChoice([2,3,5,7]); var e7=randInt(2,5);
      var stem3='Scrittura compatta'; var meta3='Scrivi in forma di potenza: ' + new Array(e7+1).join(String(a7)+' √ó ').slice(0,-3);
      var correct2 = a7+'^'+e7;
      return makeQ('Potenze','mc',stem3,meta3,correct2, sanitizeChoices(stem3+' '+meta3, [correct2, a7+'^'+(e7-1), (a7+1)+'^'+e7, a7+'^'+(e7+1)], correct2), ['Conta quante volte ripeti la base'], correct2);
    }
  },
  "Radici": function(D){ var sq=randChoice([36,49,64,81,100,121,144,169]); return makeQ('Radici','input','Calcola la radice quadrata','‚àö'+sq+'. Rispondi con un intero.', Math.sqrt(sq), null, ['Numero che al quadrato d√† '+sq], String(Math.sqrt(sq))); },
  "Numero teoria": function(D){ var a=randInt(6*D,20*D), b=randInt(6*D,20*D); var mode=randChoice(['MCD','mcm']); if(mode==='MCD'){ var ans=gcd(a,b); return makeQ('Numero teoria','input','Massimo Comune Divisore','Trova MCD('+a+', '+b+'). Rispondi con un intero.', ans, null, ['Algoritmo di Euclide'], String(ans)); } var ans2=lcm(a,b); return makeQ('Numero teoria','input','Minimo comune multiplo','Trova mcm('+a+', '+b+'). Rispondi con un intero.', ans2, null, ['ab/MCD'], String(ans2)); },
  "Problemi": function(D){ var kmD=randInt(3,8), g=randInt(4,7), bonus=randInt(10,30); var base=kmD*g; var tot=dec(base*(1+bonus/100),2); return makeQ('Problemi','input','Problema su percentuali','Mia corre '+kmD+' km al giorno per '+g+' giorni. L\'ultimo giorno fa +'+bonus+'%. Quanti km totali? Arrotonda a 2 decimali.', tot, null, ['Totale base + bonus','Arrotonda a 2 decimali'], tot.toFixed(2)); },
  "Statistiche": function(D){
    var fruits=['mele','pere','arance','banane']; 
    var counts=fruits.map(function(){return randInt(6*D,15*D);}); 
    var listing = fruits.map(function(f,j){return f.charAt(0).toUpperCase()+f.slice(1)+'='+counts[j];}).join(', ');
    var variant = randChoice(['quanto-frutto','massimo','somma','differenza','vero-falso']);
    if(variant==='quanto-frutto'){ 
      var i=randInt(0,3);
      var stem='Lettura di tabella'; var meta='Tabella: '+listing+'. Quante '+fruits[i]+'?';
      var corr=String(counts[i]);
      var choices=[String(counts[i]),String(counts[i]+1),String(counts[i]-1),String(counts[(i+1)%4])];
      return makeQ('Statistiche','mc',stem,meta,corr, sanitizeChoices(stem+' '+meta, choices, corr), ['Leggi il numero accanto alla voce richiesta'], corr);
    }
    if(variant==='massimo'){
      var maxV = Math.max.apply(null, counts);
      var correct = fruits[counts.indexOf(maxV)];
      var stem2='Trova il massimo'; var meta2='Tabella: '+listing+'. Quale frutto √® il maggiore?';
      return makeQ('Statistiche','mc',stem2,meta2,correct, sanitizeChoices(stem2+' '+meta2, fruits.slice(), correct), ['Confronta i valori e scegli il maggiore'], correct);
    }
    if(variant==='somma'){
      var i2=randInt(0,3); var j2=randInt(0,3); while(j2===i2) j2=randInt(0,3);
      var ans = counts[i2]+counts[j2];
      return makeQ('Statistiche','input','Somma di due voci','Tabella: '+listing+'. Quante unit√† in totale di '+fruits[i2]+' e '+fruits[j2]+'?', ans, null, ['Somma i due valori'], String(ans));
    }
    if(variant==='differenza'){
      var i3=randInt(0,3); var j3=randInt(0,3); while(j3===i3) j3=randInt(0,3);
      var ans2 = Math.abs(counts[i3]-counts[j3]);
      return makeQ('Statistiche','input','Differenza tra voci','Tabella: '+listing+'. Quante unit√† in pi√π tra '+fruits[i3]+' e '+fruits[j3]+'? (valore assoluto)', ans2, null, ['Calcola la differenza assoluta'], String(ans2));
    }
    var i4=randInt(0,3); var j4=randInt(0,3); while(j4===i4) j4=randInt(0,3);
    var isTrue = counts[i4] > counts[j4];
    var stem3='Vero/Falso (confronto)'; var meta3='Tabella: '+listing+'. Vero o Falso: '+fruits[i4]+' sono pi√π di '+fruits[j4]+'?';
    var answer=isTrue? 'Vero':'Falso';
    return makeQ('Statistiche','mc',stem3,meta3,answer, sanitizeChoices(stem3+' '+meta3, ['Vero','Falso'], answer), ['Confronta i due numeri'], answer);
  }
};

// ===== UI helpers
function $(id){ return document.getElementById(id); }
function show(section){ ['home','train','play','progress','settings'].forEach(function(s){ $(s).style.display = (s===section? 'block':'none'); }); state.screen=section; if(section==='play'){ renderBadges(); } if(section==='progress'){ renderBadgesList(); } if(section==='home'){ renderHomeBadges(); } renderHeader(); }
function renderHeader(){ $('diffLabel').textContent = state.difficulty; $('streak').textContent = state.streak; $('topicLabel').textContent = state.topicFilter? ('Allenamento: '+state.topicFilter) : 'Allenamento: Tutti gli argomenti'; }
function renderStats(){
  var corToday = todayHistory(state.history).filter(function(h){return h.ok;}).length;
  var accAll = state.answered? Math.round(100*state.correct/state.answered):0;

  if($('correctToday')) $('correctToday').textContent = corToday;
  if($('corToday2')) $('corToday2').textContent = corToday;
  if($('goalSmall')) $('goalSmall').textContent = state.dailyGoal;
  if($('goalVal')) $('goalVal').textContent = state.dailyGoal;
  if($('goalVal2')) $('goalVal2').textContent = state.dailyGoal;

  if($('ansAll')) $('ansAll').textContent = state.answered;
  if($('corAll')) $('corAll').textContent = state.correct;
  if($('corAll2')) $('corAll2').textContent = state.correct;
  if($('accAll')) $('accAll').textContent = accAll+'%';
  if($('accTot')) $('accTot').textContent = accAll+'%';
  if($('totAns')) $('totAns').textContent = state.answered;

  var pct = Math.min(100, Math.round(100*corToday/Math.max(1,state.dailyGoal)));
  if($('goalBar')) $('goalBar').style.width = pct+'%';
  if($('goalBar2')) $('goalBar2').style.width = pct+'%';
  var left = Math.max(0, state.dailyGoal - corToday);
  if($('goalHint')) $('goalHint').textContent = left>0 ? ('Ti mancano '+left+' risposte corrette per l\'obiettivo di oggi.') : 'Obiettivo raggiunto!';
  if($('goalNote')) $('goalNote').textContent = 'Se non completi oggi, domani l\'obiettivo salir√† a circa '+Math.ceil(state.dailyGoal*1.10)+' ( +10% )';
  if($('daysDone')) $('daysDone').textContent = 'Giorni obiettivo completato: '+state.completions.length;
}

// ===== Question flow
function makeQuestion(){
  var D = state.difficulty;
  if(state.topicFilter && Builders[state.topicFilter]){
    return Builders[state.topicFilter](D);
  } else {
    var keys = Object.keys(Builders);
    var topic = randChoice(keys);
    return Builders[topic](D);
  }
}

function renderQuestion(){
  var q = makeQuestion(); state.question = q; state.input=''; state.answeredThis=false; applyAccentForTopic(q.topic);
  $('topicLabel').textContent = state.topicFilter? ('Allenamento: '+state.topicFilter) : 'Allenamento: Tutti gli argomenti';
  $('stem').textContent = q.stem; $('stemMeta').textContent = q.meta||''; $('feedback').innerHTML=''; $('hints').style.display='none'; $('hints').textContent = (q.hints||[]).map(function(h){return '‚Ä¢ '+h;}).join('\n');
  var ui = $('answerUI'); ui.innerHTML=''; var nextBtn=$('btnNext'); if(nextBtn) nextBtn.disabled=true;
  if(q.type==='mc'){
    var grid=document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='1fr 1fr'; grid.style.gap='8px';
    q.choices.forEach(function(ch){
      var b=document.createElement('button'); b.setAttribute('type','button'); b.className='choice'; b.textContent=ch;
      b.onclick=function(){ state.input=String(ch); Array.prototype.forEach.call(grid.children, function(x){x.classList.remove('active');}); b.classList.add('active'); if(state.autoConfirmMC){ setTimeout(function(){ confirmAnswer(); },150); } else if(nextBtn) { nextBtn.disabled=false; } };
      grid.appendChild(b);
    });
    ui.appendChild(grid);
  } else {
    var inp=document.createElement('input'); inp.type='text'; inp.className='answer'; inp.placeholder='Scrivi qui la risposta';
    inp.onkeydown=function(e){ if(e.key==='Enter'){ confirmAnswer(); } };
    inp.oninput=function(e){ state.input=e.target.value; };
    ui.appendChild(inp); inp.focus();
  }
  renderHeader();
}

function maybeCompleteGoal(){
  var corToday = todayHistory(state.history).filter(function(h){return h.ok;}).length;
  if(corToday >= state.dailyGoal && !state.goalShownToday){
    state.goalShownToday = true;
    var accAll = state.answered? Math.round(100*state.correct/state.answered):0;
    if($('goalCount')) $('goalCount').textContent = corToday;
    if($('goalCountTot')) $('goalCountTot').textContent = state.dailyGoal;
    if($('goalAcc')) $('goalAcc').textContent = accAll;
    var key = dayKey();
    if(state.completions.indexOf(key)===-1){ state.completions.push(key); }
    addBadge('daily_hero','Daily Hero');
    addBadge('daily_goal_'+key, 'Obiettivo Giornaliero ('+key+')');
    saveState();
    var overlay = $('overlay');
    overlay.style.display = 'flex';
    var n=5; $('countdown').textContent = n;
    var int = setInterval(function(){ n--; $('countdown').textContent = n; if(n<=0){ clearInterval(int); overlay.style.display='none'; show('home'); } }, 1000);
    $('btnHomeNow').onclick = function(){ overlay.style.display='none'; clearInterval(int); show('home'); };
  }
}

function confirmAnswer(){
  if(!state.question || state.answeredThis) return;
  var ok=false; var ans = state.question.answer;
  if(typeof ans==='number'){ ok = approxEqual(Number(state.input), ans); }
  else { ok = String(state.input).trim()===String(ans).trim(); }

  state.answered++; 
  if(ok){ state.correct++; state.streak++; $('feedback').innerHTML = "<div class='ok'><b>Corretto!</b> Ben fatto.</div>"; maybeCompleteGoal(); setTimeout(function(){ autoAdjustDifficulty(); }, 0); if(state.autoAdvance){ setTimeout(function(){ renderQuestion(); }, 900); } }
  else { state.streak=0; $('feedback').innerHTML = "<div class='bad'><b>Non √® corretto.</b> Proviamo insieme.<br><br><b>Soluzione attesa:</b> "+state.question.solution+(state.question.meta?("<br><br><b>Richiesta:</b> "+state.question.meta):"")+"</div>"; setTimeout(function(){ autoAdjustDifficulty(); }, 0); }

  // push history without spread/shorthand
  state.history.push({ topic: state.question.topic, type: state.question.type, stem: state.question.stem, meta: state.question.meta, given: state.input, answer: state.question.answer, ok: ok, ts: Date.now() });

  state.answeredThis=true; 
  if($('btnNext')) $('btnNext').disabled=false;
  renderStats(); saveState(); ensureCatalogBadges(); renderHomeBadges();
}

function nextQuestion(){ renderQuestion(); }
function toggleHint(){ var h=$('hints'); h.style.display = (h.style.display==='none')? 'block':'none'; }
function similar(){ if(!state.question) return; renderQuestion(); }

// ===== Navigation & controls
$('btnHome').onclick=function(){ show('home'); };
$('btnPlay').onclick=function(){ show('play'); renderStats(); renderQuestion(); if($('btnNext')) $('btnNext').disabled=true; };
$('btnTrain').onclick=function(){ show('train'); renderStats(); };
$('btnProg').onclick=function(){ show('progress'); renderStats(); renderByTopic(); renderBadgesList(); };
$('btnSettings').onclick=function(){ show('settings'); renderStats(); };
$('startQuick').onclick=function(){ show('play'); renderStats(); renderQuestion(); if($('btnNext')) $('btnNext').disabled=true; };
$('startTrain').onclick=function(){ show('train'); };
$('trainGo').onclick=function(){ show('play'); renderStats(); renderQuestion(); if($('btnNext')) $('btnNext').disabled=true; };
$('resetTopic').onclick=function(){ state.topicFilter=null; Array.prototype.forEach.call($('topics').children, function(x){x.classList.remove('active');}); saveState(); renderHeader(); };
$('btnConfirm').onclick=confirmAnswer;
$('btnNext').onclick=function(){ if(!state.answeredThis){ $('feedback').innerHTML = "<div class='bad'><b>Prima prova a rispondere.</b> Non puoi saltare senza fare un tentativo.</div>"; return; } nextQuestion(); };
$('btnHint').onclick=toggleHint;
$('btnSimilar').onclick=similar;
$('btnExport').onclick=function(){
  var rows = [['timestamp','day','topic','stem','meta','given','answer','ok']];
  state.history.forEach(function(h){ rows.push([new Date(h.ts).toISOString(), dayKey(h.ts), h.topic, h.stem, h.meta||'', h.given, h.answer, h.ok]); });
  var csv = rows.map(function(r){ return r.map(function(x){ return '"'+String(x).replace(/"/g,'""')+'"'; }).join(','); }).join('\n');
  var blob = new Blob([csv], {type:'text/csv'});
  var url = URL.createObjectURL(blob);
  var a = document.createElement('a'); a.href=url; a.download='mathquest_report.csv'; a.click(); URL.revokeObjectURL(url);
};
$('btnReset').onclick=function(){ if(confirm('Cancellare tutti i dati?')){ localStorage.removeItem('mqLiteState'); location.reload(); } };
$('toggleAuto').onchange=function(e){ state.autoAdvance = e.target.checked; saveState(); };
$('toggleAutoMC').onchange=function(e){ state.autoConfirmMC = e.target.checked; saveState(); };
$('toggleAutoDiff').onchange=function(e){ state.autoDiff = e.target.checked; saveState(); autoAdjustDifficulty(); };

// Levels (manual)
var levels=$('levels'); [1,2,3].forEach(function(d){
  var b=document.createElement('button'); b.className='pill'; b.textContent=d;
  b.onclick=function(){ state.difficulty=d; Array.prototype.forEach.call(document.querySelectorAll('.pill'), function(x){x.classList.remove('active');}); b.classList.add('active'); var dl=document.getElementById('diffLabel'); if(dl) dl.textContent=d; saveState(); };
  if(d===state.difficulty) b.classList.add('active'); levels.appendChild(b);
});

// Topics (Allenamento mirato)
var topicsEl=$('topics'); topicsList.forEach(function(t){
  var b=document.createElement('button'); b.className='pill'; b.textContent=t;
  b.onclick=function(){ if(state.topicFilter===t){ state.topicFilter=null; b.classList.remove('active'); } else { state.topicFilter=t; Array.prototype.forEach.call(topicsEl.children, function(x){x.classList.remove('active');}); b.classList.add('active'); } saveState(); renderHeader(); };
  topicsEl.appendChild(b);
});

// Quick Topics (Home)
var quick=$('quickTopics'); topicsList.forEach(function(t){
  var b=document.createElement('button'); b.className='pill'; b.textContent=t;
  b.onclick=function(){ state.topicFilter=t; saveState(); renderHeader(); show('play'); renderStats(); renderQuestion(); if($('btnNext')) $('btnNext').disabled=true; };
  quick.appendChild(b);
});
$('clearTopic').onclick=function(){ state.topicFilter=null; saveState(); renderHeader(); };

function renderByTopic(){ var wrap=$('byTopic'); if(!wrap) return; wrap.innerHTML=''; var accBy={}; state.history.forEach(function(h){ if(!accBy[h.topic]) accBy[h.topic]={c:0,t:0}; accBy[h.topic].t++; if(h.ok) accBy[h.topic].c++; }); if(Object.keys(accBy).length===0){ wrap.textContent='Ancora nessun dato. Fai qualche esercizio!'; if($('suggestions')) $('suggestions').textContent=''; return; } Object.keys(accBy).forEach(function(t){ var data=accBy[t]; var pct = Math.round(100*data.c/data.t); var card=document.createElement('div'); card.className='card'; card.innerHTML='<div style=\"font-weight:600\">'+t+'</div><div class=\"kicker\">'+data.c+'/'+data.t+' corrette ('+pct+'%)</div><div class=\"progress\" style=\"margin-top:6px\"><div class=\"bar\" style=\"width:'+pct+'%\"></div></div>'; wrap.appendChild(card); }); var sorted = Object.keys(accBy).map(function(k){return [k,accBy[k]];}).sort(function(a,b){ return (a[1].c/a[1].t) - (b[1].c/b[1].t); }); var low = sorted.slice(0,2).map(function(x){return x[0];}); if($('suggestions')) $('suggestions').textContent = low.length? ('Suggerimento: fai 10 min su ' + low.join(' e ') + '.') : ''; }

// Initial
(function init(){
  try { loadState(); } catch(e){}
  rollDailyGoalOnNewDay();
  renderStats();
  $('toggleAuto').checked = !!state.autoAdvance;
  $('toggleAutoMC').checked = !!state.autoConfirmMC;
  $('toggleAutoDiff').checked = !!state.autoDiff;
  autoAdjustDifficulty();
  renderBadges();
  renderBadgesList();
  renderHomeBadges();
  ensureCatalogBadges();
})();
</script>
</body>
</html>
